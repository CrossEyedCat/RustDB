# Архитектура взаимодействия компонентов RustDB

## Обзор архитектуры

RustDB построена по многослойной архитектуре, где каждый слой отвечает за определенную функциональность и взаимодействует с другими слоями через четко определенные интерфейсы.

## Слои архитектуры

### 1. Клиентский слой
**Назначение**: Предоставляет интерфейсы для взаимодействия с базой данных

**Компоненты**:
- **CLI Client** - командная строка для выполнения SQL запросов
- **Network Client** - сетевые клиенты (драйверы для различных языков)

**Взаимодействие**: Отправляет SQL запросы на сервер и получает результаты

### 2. Сетевой слой
**Назначение**: Обрабатывает сетевые соединения и протоколы

**Компоненты**:
- **Network Server** - принимает входящие соединения
- **Connection Pool** - управляет пулом соединений для эффективности

**Взаимодействие**: 
- Принимает запросы от клиентов
- Передает запросы в основной сервер
- Отправляет результаты обратно клиентам

### 3. Основной сервер
**Назначение**: Координирует выполнение запросов и управляет сессиями

**Компоненты**:
- **Main Server** - центральный координатор
- **Session Manager** - управляет пользовательскими сессиями

**Взаимодействие**:
- Получает запросы от сетевого слоя
- Создает и управляет сессиями пользователей
- Координирует выполнение запросов

### 4. Парсер и планировщик
**Назначение**: Анализирует SQL запросы и создает планы выполнения

**Компоненты**:
- **SQL Parser** - разбирает SQL на токены
- **AST Builder** - строит абстрактное синтаксическое дерево
- **Query Planner** - создает план выполнения запроса
- **Query Optimizer** - оптимизирует план для лучшей производительности

**Взаимодействие**:
- Получает SQL запросы от Session Manager
- Обращается к Schema Manager для получения метаданных
- Создает оптимизированный план выполнения
- Передает план в Query Executor

### 5. Исполнитель запросов
**Назначение**: Выполняет запросы согласно плану

**Компоненты**:
- **Query Executor** - координирует выполнение операторов
- **Operator Tree** - дерево операторов для выполнения
- **Result Set** - формирует результаты запроса

**Взаимодействие**:
- Получает план от Query Optimizer
- Создает дерево операторов
- Взаимодействует с Transaction Manager для управления транзакциями
- Обращается к Buffer Manager для получения данных
- Формирует и возвращает результаты

### 6. Ядро базы данных
**Назначение**: Обеспечивает основные функции СУБД

**Компоненты**:
- **Transaction Manager** - управляет ACID транзакциями
- **Lock Manager** - обеспечивает изоляцию транзакций
- **Recovery Manager** - логирует операции и восстанавливает систему
- **Buffer Manager** - управляет кэшированием страниц в памяти

**Взаимодействие**:
- Transaction Manager координирует все операции
- Lock Manager блокирует ресурсы для изоляции
- Recovery Manager записывает все изменения в лог
- Buffer Manager кэширует часто используемые страницы

### 7. Хранилище данных
**Назначение**: Управляет физическим хранением данных

**Компоненты**:
- **Page Manager** - работает со страницами данных
- **File Manager** - управляет файлами базы данных
- **Index Manager** - поддерживает индексы (B+ деревья, хеши)
- **Table Manager** - управляет структурой таблиц

**Взаимодействие**:
- Page Manager взаимодействует с Buffer Manager
- File Manager читает и записывает данные на диск
- Index Manager обеспечивает быстрый поиск
- Table Manager управляет схемой данных

### 8. Каталог метаданных
**Назначение**: Хранит информацию о структуре базы данных

**Компоненты**:
- **Schema Manager** - управляет схемой таблиц и колонок
- **Statistics Manager** - собирает статистику о данных
- **Access Control** - управляет правами доступа

**Взаимодействие**:
- Предоставляет метаданные для парсера и планировщика
- Обновляется при изменении структуры БД
- Контролирует доступ пользователей к объектам

### 9. Физическое хранение
**Назначение**: Файлы на диске

**Компоненты**:
- **Data Files** - файлы с данными таблиц
- **Index Files** - файлы индексов
- **Log Files** - файлы журнала транзакций
- **System Catalog** - файлы метаданных

## Поток выполнения запроса

### 1. Получение запроса
```
CLI Client → Network Server → Connection Pool → Main Server → Session Manager
```

### 2. Парсинг и планирование
```
Session Manager → SQL Parser → AST Builder → Query Planner → Query Optimizer
```

### 3. Выполнение запроса
```
Query Optimizer → Query Executor → Operator Tree → Buffer Manager → Page Manager
```

### 4. Возврат результата
```
Page Manager → Buffer Manager → Query Executor → Result Set → Main Server → Network Server → CLI Client
```

## Ключевые принципы взаимодействия

### 1. Разделение ответственности
Каждый компонент отвечает за свою область и не вмешивается в работу других

### 2. Слабая связанность
Компоненты взаимодействуют через четко определенные интерфейсы

### 3. Высокая когезия
Связанная функциональность группируется в одном компоненте

### 4. Масштабируемость
Архитектура позволяет добавлять новые компоненты без изменения существующих

### 5. Отказоустойчивость
Система может продолжать работу при отказе отдельных компонентов

## Точки расширения

### 1. Новые типы индексов
Можно добавить новые менеджеры индексов, реализующие общий интерфейс

### 2. Дополнительные операторы
Query Executor поддерживает добавление новых типов операторов

### 3. Альтернативные планировщики
Можно заменить Query Optimizer на более продвинутые алгоритмы

### 4. Различные протоколы
Network Server поддерживает подключение различных протоколов

Эта архитектура обеспечивает модульность, расширяемость и надежность системы, что критически важно для реляционной базы данных.
